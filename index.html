<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VKM Label Generator (T)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style id="ui-styles">
    /* --- STYLES FOR NEW COMPACT HEADER LAYOUT --- */
    body {
      font-family: 'Montserrat', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      margin: 0;
      background-color: #f4f4f4;
    }

    /* NEW: Main sticky container for both header bars */
    #app-header {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* NEW: Top bar for Title and Logout */
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2c3e50; /* Dark blue/grey */
      color: white;
      padding: 12px 30px;
    }
    #top-bar h1 {
      font-size: 22px;
      margin: 0;
      color: white;
      text-align: left;
    }
    .header-buttons {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #showReprintBtn, .logout-btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      margin: 0;
      box-shadow: none;
      transition: background-color 0.2s ease;
    }
    #showReprintBtn {
      background: #7f8c8d;
      border: 1px solid #95a5a6;
    }
    #showReprintBtn:hover {
      background: #95a5a6;
      transform: none;
    }
    .logout-btn {
      background-color: #e74c3c;
      border: 1px solid #c0392b;
    }
    .logout-btn:hover {
      background-color: #c0392b;
      transform: none;
    }

    /* NEW: Second bar for Tabs and Actions */
    #nav-action-bar {
      background-color: #fff;
      padding: 0 30px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .tab {
      padding: 12px 20px;
      background: transparent;
      cursor: pointer;
      border-radius: 0;
      font-weight: 600;
      color: #555;
      transition: all 0.2s ease;
      text-align: center;
      font-size: 14px;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      color: #1976d2;
      border-bottom: 3px solid #1976d2;
      background: transparent;
      box-shadow: none;
    }
    .tab:hover:not(.active) {
      background: #f5f5f5;
      color: #333;
    }

    #contextual-actions {
      padding: 12px 0;
    }
    .action-buttons {
      display: none;
      gap: 15px;
      align-items: center;
    }
    .action-buttons.active {
      display: flex;
    }
    
    /* MODIFIED: Main content container styling */
    .container {
      max-width: 1200px;
      width: auto;
      margin: 25px 30px; /* Spacing from header and sides */
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 25px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus {
      border-color: #1976d2;
      outline: none;
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
    }
    button {
      padding: 12px 25px;
      background: linear-gradient(180deg, #2196f3 0%, #1976d2 100%);
      color: white;
      border: none;
      border-radius: 9999px;
      cursor: pointer;
      margin-right: 0;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .action-buttons button {
        font-size: 14px;
        padding: 10px 22px;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .preview-area {
      display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px;
      padding: 10px; border: 1px dashed #ccc; border-radius: 8px; min-height: 150px;
      align-items: center; background-color: #fcfcfc;
    }
    .table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      border-radius: 8px;
      overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .table th, .table td {
      border: 1px solid #ddd;
      padding: 12px; text-align: left; font-size: 15px;
    }
    .table th {
      background: #1976d2;
      color: white; font-weight: bold;
    }
    .table tr:nth-child(even) { background-color: #f9f9f9;
    }
    .table tr:hover { background-color: #e3f2fd; }
    .table button { padding: 6px 12px;
      font-size: 14px; margin-right: 5px; box-shadow: none; }
    .error {
      color: #d32f2f;
      margin-top: 15px; font-weight: bold; text-align: center; padding: 10px;
      background-color: #ffcdd2; border: 1px solid #ef9a9a; border-radius: 6px;
    }
    /* Login & Message Box Styles */
    .message-box-overlay { position: fixed;
      top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center;
      z-index: 1000; }
    .message-box-overlay.active { display: flex; }
    .message-box { background: #fff; padding: 30px;
      border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); text-align: center; max-width: 400px; width: 90%;
    }
    .message-box p { margin-bottom: 20px; font-size: 18px; color: #333;
    }
    .message-box input, .message-box select { margin-bottom: 15px; width:100%; padding:10px; border:1px solid #ccc; border-radius: 6px;
      box-sizing: border-box;}
    .message-box button { margin: 10px 5px 0; }
    #loadingOverlay { display: none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 9999; justify-content: center;
      align-items: center; flex-direction: column; }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #1976d2; border-radius: 50%;
      width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);
      } 100% { transform: rotate(360deg); } }
    #loginForm { display: none; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; width: 100%; }
    #loginBox { background-color: #fff; padding: 40px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
    #loginBox h2 { color: #1976d2;
      margin-bottom: 25px; }
    #loginBox .form-group { text-align: left; }
    #loginBox button { width: 100%;
      margin-top: 10px; }
    .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px;
    }
    
    /* Hides the Counter and Reference columns in the history tables */
    #historyTable th:nth-child(6),
    #historyTable td:nth-child(6),
    #historyTable th:nth-child(7),
    #historyTable td:nth-child(7),
    #batchHistoryTable th:nth-child(6),
    #batchHistoryTable td:nth-child(6),
    #batchHistoryTable th:nth-child(7),
    #batchHistoryTable td:nth-child(7) {
      display: none;
    }

    @media (max-width: 768px) { .preview-area { transform: scale(0.8); transform-origin: top center;
      } }
    
    @media print {
        body, #app-header, .container, .form-group, .error, #loadingOverlay, #messageBoxOverlay, .pagination-controls, h1, h2, select, input, button {
            display: none !important;
        }
        .preview-area { display: block !important; margin: 0 !important; padding: 0 !important;
          border: none !important; background: none !important; box-shadow: none !important; min-height: auto !important; width: auto !important;
        }
        .label-container { margin: 0; border: none; box-shadow: none; page-break-after: always; overflow: hidden;
        }
        .label-container:last-child { page-break-after: auto;
        }
    }
  </style>

  <style id="pure-label-styles">
    .label-container {
      width: 5cm;
      height: 2.5cm;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 0.15cm;
      display: grid;
      grid-template-columns: 1.6cm minmax(0, 1fr) 1.3cm;
      align-items: center;
      gap: 0.2cm;
      padding: 0.15cm;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    .qr-code {
      width: 1.5cm;
      height: 1.5cm; 
      margin-left: 0.2cm; 
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    
    .qr-code img, .qr-code canvas {
        width: 100% !important;
        height: 100% !important;
    }

    .text-info {
      font-family: 'Arial Narrow', 'Helvetica Condensed', sans-serif;
      font-size: 7.5px;
      font-weight: normal;
      line-height: 1.4;
      white-space: nowrap;
      text-align: left;
      align-self: start;
      padding-top: 0.29cm;
      margin-left: 0.1cm;
    }

    .text-info p {
      margin: 0;
    }

    .hri-text {
      font-family: 'Arial Narrow', 'Helvetica Condensed', sans-serif;
      font-size: 7pt;
      font-weight: normal;
      text-transform: uppercase;
      color: #000;
      margin: 0;
      padding: 0;
    }

    .hri-text-mixed {
      font-family: 'Arial Narrow', 'Helvetica Condensed', sans-serif;
      font-size: 7pt;
      font-weight: normal;
      text-transform: none;
      color: #000;
      margin: 0;
      padding: 0;
    }

    .logo-section {
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 1cm;
    }

    .logo-section img {
      width: 1.0cm;
      height: 1.1cm;
      object-fit: contain;
      display: block;
      margin-left: 0.4cm;
    }
  </style>
</head>
<body>
  <div id="loadingOverlay"><div class="spinner"></div></div>

  <div id="loginForm">
    <div id="loginBox">
      <h2>Login</h2>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" />
      </div>
      <button id="loginButton">Login</button>
      <div id="loginError" class="error" style="display:none;"></div>
    </div>
  </div>

  <div id="app-header" style="display:none;">
    <div id="top-bar">
      <h1>VKM Label Generator (T)</h1>
      <div class="header-buttons">
        <button id="showReprintBtn">Show Reprint</button>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>
    <div id="nav-action-bar">
      <div class="tabs">
        <div class="tab active" data-tab="serial-generate">Serial No Generate (A)</div>
        <div class="tab" data-tab="batch-generate">Batch Label Generate (B)</div>
        <div class="tab" data-tab="reprint" id="reprintTab" style="display: none;">Reprint</div>
        <div class="tab" data-tab="parts">Part Manager</div>
        <div class="tab" data-tab="vendors">Vendor Manager</div>
        <div class="tab" data-tab="history">Serial History</div>
        <div class="tab" data-tab="batch-history">Batch History</div>
      </div>
      <div id="contextual-actions">
        <div data-context="serial-generate" class="action-buttons active">
          <button id="generateSerialBtn">Generate Labels</button>
          <button id="exportPdfSerialBtn">Export to PDF</button>
          <button id="printSerialBtn">Print Labels</button>
        </div>
        <div data-context="batch-generate" class="action-buttons">
          <button id="generateBatchBtn">Generate Labels</button>
          <button id="exportPdfBatchBtn">Export to PDF</button>
          <button id="printBatchBtn">Print Labels</button>
        </div>
        <div data-context="reprint" class="action-buttons">
          <button id="reprintLabelBtn">Reprint Label</button>
          <button id="exportPdfReprintBtn">Export to PDF</button>
          <button id="printReprintBtn">Print Label</button>
        </div>
        <div data-context="parts" class="action-buttons">
          <button id="addPartBtn">Add Part</button>
          <button id="exportPartsCsvBtn">Export to CSV</button>
        </div>
        <div data-context="vendors" class="action-buttons">
          <button id="addVendorBtn">Add Vendor</button>
          <button id="exportVendorsCsvBtn">Export to CSV</button>
        </div>
        <div data-context="history" class="action-buttons">
          <button id="filterHistoryBtn">Search History</button>
          <button id="exportHistoryFilteredBtn">Export Filtered</button>
        </div>
        <div data-context="batch-history" class="action-buttons">
          <button id="filterBatchHistoryBtn">Search History</button>
          <button id="exportBatchHistoryFilteredBtn">Export Filtered</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container" id="mainContent" style="display:none;">
    <div id="serial-generate" class="tab-content active">
      <div class="form-group">
        <label for="partSelectSerial">Part Number (Serial)</label>
        <select id="partSelectSerial"></select>
      </div>
      <div class="form-group">
        <label for="quantitySerial">Quantity (1-1000)</label>
        <input type="number" id="quantitySerial" min="1" max="1000" value="1" />
      </div>
      <div class="preview-area" id="previewAreaSerial"></div>
      <div id="generateErrorSerial" class="error" style="display:none;"></div>
    </div>
    
    <div id="batch-generate" class="tab-content">
      <div class="form-group">
        <label for="partSelectBatch">Part Number (Batch)</label>
         <select id="partSelectBatch"></select>
      </div>
      <div class="form-group">
        <label for="quantityBatch">Quantity (1-1000)</label>
        <input type="number" id="quantityBatch" min="1" max="1000" value="1" />
      </div>
      <div class="preview-area" id="previewAreaBatch"></div>
      <div id="generateErrorBatch" class="error" style="display:none;"></div>
    </div>
     
    <div id="reprint" class="tab-content">
      <div class="form-group">
        <label for="serialSearch">Serial Number (with (S) or (1T) prefix)</label>
        <input type="text" id="serialSearch" placeholder="e.g., (S) HNA25267355001 or (1T) ..." />
      </div>
      <div class="preview-area" id="reprintPreview"></div>
      <div id="reprintError" class="error" style="display:none;"></div>
    </div>
    
    <div id="parts" class="tab-content">
      <table class="table" id="partsTable">
        <thead>
          <tr>
            <th>Part Number</th>
            <th>Description</th>
            <th>Vendor Code</th>
            <th>Active</th>
            <th>Label Type</th>
            <th>Internal Part No</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="partsError" class="error" style="display:none;"></div>
    </div>
    
    <div id="vendors" class="tab-content">
      <table class="table" id="vendorsTable">
        <thead>
           <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="vendorsError" class="error" style="display:none;"></div>
    </div>
    
    <div id="history" class="tab-content">
      <div style="display: flex; gap: 20px; margin-bottom: 18px;">
        <div class="form-group" style="flex: 1;">
          <label for="historyStartDate">Start Date:</label>
          <input type="date" id="historyStartDate">
        </div>
        <div class="form-group" style="flex: 1;">
          <label for="historyEndDate">End Date:</label>
          <input type="date" id="historyEndDate">
        </div>
      </div>
      <div class="form-group">
        <label for="historySerialSearch">Search by Serial:</label>
        <input type="text" id="historySerialSearch" placeholder="Enter full or partial serial">
      </div>
       <div class="form-group">
        <label for="historyPartSearch">Search by Part:</label>
        <input type="text" id="historyPartSearch" placeholder="Enter full or partial part number">
      </div>
      <table class="table" id="historyTable">
        <thead><tr><th>Serial</th><th>Part</th><th>Description</th><th>Vendor</th><th>Date</th><th>Counter</th><th>Reference</th></tr></thead>
        <tbody></tbody>
      </table>
       <div class="pagination-controls" id="pagination-history"></div>
       <div id="historyError" class="error" style="display:none;"></div>
    </div>

    <div id="batch-history" class="tab-content">
        <div style="display: flex; gap: 20px; margin-bottom: 18px;">
          <div class="form-group" style="flex: 1;">
            <label for="batchHistoryStartDate">Start Date:</label>
            <input type="date" id="batchHistoryStartDate">
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="batchHistoryEndDate">End Date:</label>
            <input type="date" id="batchHistoryEndDate">
          </div>
        </div>
        <div class="form-group">
            <label for="batchHistorySerialSearch">Search by Serial:</label>
            <input type="text" id="batchHistorySerialSearch" placeholder="Enter full or partial serial">
         </div>
        <div class="form-group">
             <label for="batchHistoryPartSearch">Search by Part:</label>
             <input type="text" id="batchHistoryPartSearch" placeholder="Enter full or partial part number">
        </div>
           <table class="table" id="batchHistoryTable">
          <thead><tr><th>Serial</th><th>Part</th><th>Description</th><th>Vendor</th><th>Date</th><th>Counter</th><th>Reference</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="pagination-controls" id="pagination-batch-history"></div>
        <div id="batchHistoryError" class="error" style="display:none;"></div>
    </div>
  </div>

  <div id="messageBoxOverlay" class="message-box-overlay">
    <div class="message-box">
      <p id="messageBoxText"></p>
      <div id="messageBoxInputs"></div>
      <div class="button-group">
        <button id="messageBoxConfirm">OK</button>
        <button id="messageBoxCancel" class="cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- SUPABASE SETUP ---
    // STEP 1: Your Supabase project credentials.
    const SUPABASE_URL = 'https://iiquuthmedevvobqakif.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlpcXV1dGhtZWRldnZvYnFha2lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3ODQ0OTIsImV4cCI6MjA3NDM2MDQ5Mn0.QHh1RpIxFvkiUGLLliXCID5dJWijiGwqiAXUWNJEcKU';

    // Initialize the Supabase client
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // STEP 2: Configure your Logo
    // Upload your logo to Supabase Storage in a public bucket (e.g., 'assets')
    // and this URL will point to it.
    // MODIFIED: Changed file extension to .jpg to match your file.
    const LOGO_URL = `${SUPABASE_URL}/storage/v1/object/public/assets/logo.jpg`; 

    // --- GLOBAL STATE ---
    const jsPDF = window.jspdf.jsPDF;
    let TESLA_LOGO_BASE64 = ''; // This will be loaded from the LOGO_URL
    let allParts = [];
    let allVendors = [];
    let labelDataCache = {}; // **NEW**: Caches data for the fast PDF export
    const historyState = {
        Serial: { currentPage: 1, itemsPerPage: 20, total: 0, filter: { serial: '', part: '', startDate: '', endDate: '' } },
        Batch: { currentPage: 1, itemsPerPage: 20, total: 0, filter: { serial: '', part: '', startDate: '', endDate: '' } }
    };

    // --- INITIALIZATION & AUTH ---
    function showApp() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('app-header').style.display = 'block';
        document.getElementById('mainContent').style.display = 'block';
        initialize();
    }

    function showLogin() {
        document.getElementById('loginForm').style.display = 'flex';
        document.getElementById('app-header').style.display = 'none';
        document.getElementById('mainContent').style.display = 'none';
    }

    async function handleLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      showLoading();
      try {
        const { data, error } = await db.auth.signInWithPassword({ email, password });
        if (error) throw error;
        // The onAuthStateChange listener will handle showing the app
      } catch (err) {
        showError('loginError', 'Login failed: ' + err.message + '. Please check your credentials and ensure the user is set up in Supabase.');
      } finally {
        hideLoading();
      }
    }

    async function logout() {
      showLoading();
      const { error } = await db.auth.signOut();
      if (error) {
        showMessageBox('Logout failed: ' + error.message);
      }
      // The onAuthStateChange listener will handle showing the login page
      hideLoading();
    }
    
    // Function to convert image URL to Base64
    async function imageUrlToBase64(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Logo not found at ${url}. Make sure it's uploaded and public.`);
            }
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        } catch (error) {
            console.error("Failed to load or convert the logo image:", error);
            // Return a placeholder if the logo fails to load
            return 'https://placehold.co/100x110?text=Logo+Err';
        }
    }

    async function initialize() {
        showLoading();
        try {
            TESLA_LOGO_BASE64 = await imageUrlToBase64(LOGO_URL);
            await Promise.all([loadParts(), loadVendors()]);
        } catch (err) {
            console.error('Initialization failed:', err);
            showError('generateErrorSerial', 'Initialization Failed: ' + err.message);
        } finally {
            hideLoading();
        }
    }

    // --- EVENT LISTENERS & DOM MANIPULATION ---
    function onDomReady() {
        document.getElementById('loginButton').addEventListener('click', handleLogin);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('showReprintBtn').addEventListener('click', toggleReprint);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelector('.tab.active')?.classList.remove('active');
                document.querySelector('.tab-content.active')?.classList.remove('active');
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                
                document.getElementById(tabName).classList.add('active');
                document.querySelector('#contextual-actions .action-buttons.active')?.classList.remove('active');
                const activeActions = document.querySelector(`#contextual-actions [data-context="${tabName}"]`);
                if (activeActions) activeActions.classList.add('active');

                if (tabName === 'history' && !document.querySelector('#historyTable tbody').innerHTML) loadHistory('Serial', 1);
                if (tabName === 'batch-history' && !document.querySelector('#batchHistoryTable tbody').innerHTML) loadHistory('Batch', 1);
            });
        });

        // --- Attach all button event listeners ---
        document.getElementById('generateSerialBtn').addEventListener('click', () => generateLabels('Serial'));
        document.getElementById('exportPdfSerialBtn').addEventListener('click', () => exportToPDF('previewAreaSerial'));
        document.getElementById('printSerialBtn').addEventListener('click', () => printLabels('previewAreaSerial'));
        document.getElementById('generateBatchBtn').addEventListener('click', () => generateLabels('Batch'));
        document.getElementById('exportPdfBatchBtn').addEventListener('click', () => exportToPDF('previewAreaBatch'));
        document.getElementById('printBatchBtn').addEventListener('click', () => printLabels('previewAreaBatch'));
        document.getElementById('reprintLabelBtn').addEventListener('click', reprintLabel);
        document.getElementById('exportPdfReprintBtn').addEventListener('click', () => exportToPDF('reprintPreview'));
        document.getElementById('printReprintBtn').addEventListener('click', () => printLabels('reprintPreview'));
        document.getElementById('addPartBtn').addEventListener('click', addPart);
        document.getElementById('exportPartsCsvBtn').addEventListener('click', () => exportToCsv(allParts, 'VKM_Parts.csv'));
        document.getElementById('addVendorBtn').addEventListener('click', addVendor);
        document.getElementById('exportVendorsCsvBtn').addEventListener('click', () => exportToCsv(allVendors, 'VKM_Vendors.csv'));
        document.getElementById('filterHistoryBtn').addEventListener('click', () => filterHistory('Serial'));
        document.getElementById('exportHistoryFilteredBtn').addEventListener('click', () => exportHistoryToCsv('Serial', true));
        document.getElementById('filterBatchHistoryBtn').addEventListener('click', () => filterHistory('Batch'));
        document.getElementById('exportBatchHistoryFilteredBtn').addEventListener('click', () => exportHistoryToCsv('Batch', true));

        document.getElementById('partsTable').addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;
            const partNumber = target.dataset.partNumber;
            if (target.classList.contains('edit-part-btn')) editPart(partNumber);
            if (target.classList.contains('delete-part-btn')) deletePart(partNumber);
        });

        document.getElementById('vendorsTable').addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;
            const vendorCode = target.dataset.vendorCode;
            if (target.classList.contains('edit-vendor-btn')) editVendor(vendorCode);
            if (target.classList.contains('delete-vendor-btn')) deleteVendor(vendorCode);
        });

        // Listen for authentication state changes
        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                showApp();
            } else {
                showLogin();
            }
        });
    }

    // --- CORE & UI FUNCTIONS ---
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    function showError(elementId, message) {
        const el = document.getElementById(elementId);
        if(!el) return;
        el.textContent = message;
        el.style.display = message ? 'block' : 'none';
    }

    // --- LABEL GENERATION ---
    async function generateLabels(type) {
        showLoading();
        const partNumber = document.getElementById(`partSelect${type}`).value;
        const quantity = parseInt(document.getElementById(`quantity${type}`).value, 10);
        const errorDivId = `generateError${type}`;
        const previewAreaId = `previewArea${type}`;
        const historyTable = type === 'Serial' ? 'history' : 'batch_history';
        
        try {
            showError(errorDivId, '');
            if (!partNumber || !quantity || quantity < 1 || quantity > 1000) { // **MODIFIED**: Increased limit to 1000
                throw new Error('Please select a part and enter a valid quantity (1-1000).');
            }

            const part = allParts.find(p => p.part_number === partNumber);
            if (!part) throw new Error('Part details not found.');
            
            // Get today's max counter from Supabase
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
            const { data: maxCounterData, error: counterError } = await db.from(historyTable)
                .select('counter')
                .gte('created_at', todayStart)
                .order('counter', { ascending: false })
                .limit(1);
            
            if(counterError) throw counterError;

            let counter = (maxCounterData.length > 0 ? maxCounterData[0].counter : 0) + 1;

            const year = now.getFullYear().toString().slice(-2);
            const dayOfYear = ("000" + Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000)).slice(-3);
            const internalPartNo = String(part.internal_part_no || '000').slice(-3);

            let entries = [];
            if(type === 'Serial') {
                 entries = Array.from({ length: quantity }, (_, i) => {
                    const serialCounter = ("000000" + (counter + i)).slice(-6);
                    const serialBody = part.vendor_code + year + dayOfYear + serialCounter;
                    return {
                        serial: `(S) ${serialBody}`, part: `(P)${partNumber}`,
                        description: part.description || '', vendor_code: part.vendor_code,
                        counter: counter + i, reference: internalPartNo
                    };
                });
            } else { // Batch
                const serialCounter = ("000000" + counter).slice(-6);
                const serialBody = part.vendor_code + year + dayOfYear + serialCounter;
                const finalSerial = '(1T) ' + serialBody;
                
                entries = Array.from({ length: quantity }, () => ({
                    serial: finalSerial, part: `(P)${partNumber}`,
                    description: part.description || '', vendor_code: part.vendor_code,
                    counter: counter, reference: internalPartNo
                }));
            }
            
            // Insert new entries into the database
            const { error: insertError } = await db.from(historyTable).insert(entries);
            if(insertError) throw insertError;
            
            renderLabels(previewAreaId, entries);
        } catch (err) {
            showError(errorDivId, 'Error: ' + err.message);
        } finally {
            hideLoading();
        }
    }

    async function reprintLabel() {
        showLoading();
        const serial = document.getElementById('serialSearch').value.trim();
        try {
            showError('reprintError', '');
            if (!serial) throw new Error('Please enter a serial number.');

            const type = serial.toUpperCase().startsWith('(S)') ? 'Serial' : 'Batch';
            const historyTable = type === 'Serial' ? 'history' : 'batch_history';
            
            const { data, error } = await db.from(historyTable)
                .select('*')
                .eq('serial', serial)
                .limit(1)
                .single(); // .single() returns one object or an error if not found

            if (error) throw new Error('Serial not found.');

            // The data from Supabase needs property names adjusted for renderLabels
            const entry = {
                Serial: data.serial, Part: data.part, Reference: data.reference
            };

            renderLabels('reprintPreview', [entry]);
        } catch (err) {
            showError('reprintError', 'Error: ' + err.message);
        } finally {
            hideLoading();
        }
    }
    
    function renderLabels(previewAreaId, entries) {
        const previewArea = document.getElementById(previewAreaId);
        let labelsHTML = '';

        entries.forEach((entry, i) => {
            const uniqueId = `${previewAreaId}-qr-${i}`;
            // Use the correct property names from the generated entries
            const partText = entry.part || entry.Part;
            const serialText = entry.serial || entry.Serial;
            const referenceText = entry.reference || entry.Reference;
            
            labelsHTML += `
                <div class="label-container">
                  <div class="qr-code" id="${uniqueId}"></div>
                  <div class="text-info">
                    <p class="hri-text">${partText}</p>
                    <p class="hri-text">${serialText}</p>
                    <p class="hri-text-mixed">Reference : ${referenceText || ''}</p>
                  </div>
                  <div class="logo-section">
                    <img src="${TESLA_LOGO_BASE64}" alt="Logo">
                  </div>
                </div>`;
        });
        previewArea.innerHTML = labelsHTML;

        entries.forEach((entry, i) => {
            const uniqueId = `${previewAreaId}-qr-${i}`;
            const partText = entry.part || entry.Part;
            const serialText = entry.serial || entry.Serial;

            const qrPart = partText.replace('(P)', '');
            const qrSerial = serialText.replace(/[()\s]/g, '');
            const qrData = `P${qrPart}:${qrSerial}`;
            new QRCode(document.getElementById(uniqueId), {
                text: qrData,
                width: 57,
                height: 57,
                correctLevel: QRCode.CorrectLevel.L
            });
        });

        // **MODIFIED**: Cache the data for the fast PDF export
        labelDataCache[previewAreaId] = entries;
    }

    // --- HISTORY ---
    async function loadHistory(type, page) {
        showLoading();
        historyState[type].currentPage = page;
        const offset = (page - 1) * historyState[type].itemsPerPage;
        const limit = historyState[type].itemsPerPage;
        const errorDivId = type === 'Serial' ? 'historyError' : 'batchHistoryError';
        const historyTable = type === 'Serial' ? 'history' : 'batch_history';

        try {
            showError(errorDivId, '');
            const filter = historyState[type].filter;

            let query = db.from(historyTable).select('*', { count: 'exact' });

            if (filter.serial) query = query.ilike('serial', `%${filter.serial}%`);
            if (filter.part) query = query.ilike('part', `%${filter.part}%`);
            if (filter.startDate) query = query.gte('created_at', new Date(filter.startDate).toISOString());
            if (filter.endDate) {
                const endDate = new Date(filter.endDate);
                endDate.setHours(23, 59, 59, 999);
                query = query.lte('created_at', endDate.toISOString());
            }

            query = query.order('created_at', { ascending: false }).range(offset, offset + limit - 1);
            
            const { data, error, count } = await query;
            
            if(error) throw error;

            historyState[type].total = count;
            renderHistoryTable(type, data);
            renderPagination(type);
        } catch (err) {
            showError(errorDivId, 'Error: ' + err.message);
        } finally {
            hideLoading();
        }
    }

    function renderHistoryTable(type, data) {
        const tableBody = document.querySelector(`#${type === 'Serial' ? 'historyTable' : 'batchHistoryTable'} tbody`);
        let tableHTML = '';
        if (data && data.length > 0) {
            data.forEach(entry => {
                tableHTML += `<tr>
                    <td>${entry.serial || ''}</td><td>${entry.part || ''}</td>
                    <td>${entry.description || ''}</td><td>${entry.vendor_code || ''}</td>
                    <td>${entry.created_at ? new Date(entry.created_at).toLocaleString() : ''}</td>
                    <td>${entry.counter || ''}</td><td>${entry.reference || ''}</td>
                </tr>`;
            });
        } else {
            tableHTML = '<tr><td colspan="5" style="text-align:center;">No history found.</td></tr>';
        }
        tableBody.innerHTML = tableHTML;
    }

    // --- PARTS & VENDORS ---
    async function loadParts() {
        showLoading();
        try {
            const { data, error } = await db.from('parts').select('*').order('part_number');
            if(error) throw error;
            allParts = data;
            renderPartsTable(allParts);
            populatePartSelects(allParts);
        } catch (err) {
            showError('partsError', 'Error: ' + err.message);
        } finally {
            hideLoading();
        }
    }
    
    function renderPartsTable(parts) {
        let tableHTML = '';
        parts.forEach(part => {
            tableHTML += `<tr>
                <td>${part.part_number}</td><td>${part.description}</td><td>${part.vendor_code}</td>
                <td>${part.active ? 'Yes' : 'No'}</td><td>${part.label_type}</td>
                <td>${part.internal_part_no || ''}</td>
                <td><button class="edit-part-btn" data-part-number="${part.part_number}">Edit</button>
                <button class="delete-part-btn" data-part-number="${part.part_number}">Delete</button></td>
            </tr>`;
        });
        document.querySelector('#partsTable tbody').innerHTML = tableHTML;
    }

    function populatePartSelects(parts) {
        const serialSelect = document.getElementById('partSelectSerial');
        const batchSelect = document.getElementById('partSelectBatch');
        let serialOptions = '<option value="">-- Select Serial Part --</option>';
        let batchOptions = '<option value="">-- Select Batch Part --</option>';

        parts.forEach(part => {
            if (part.active) {
                const option = `<option value="${part.part_number}">${part.part_number} - ${part.description}</option>`;
                if (part.label_type === 'Serial') serialOptions += option;
                if (part.label_type === 'Batch') batchOptions += option;
             }
        });
        serialSelect.innerHTML = serialOptions;
        batchSelect.innerHTML = batchOptions;
    }

    async function loadVendors() {
        showLoading();
        try {
            const { data, error } = await db.from('vendors').select('*').order('code');
            if (error) throw error;
            allVendors = data;
            renderVendorsTable(allVendors);
        } catch (err) {
            showError('vendorsError', 'Error: ' + err.message);
        } finally {
            hideLoading();
        }
    }

    function renderVendorsTable(vendors) {
        let tableHTML = '';
        vendors.forEach(v => {
            tableHTML += `<tr>
                <td>${v.code}</td><td>${v.name}</td>
                <td><button class="edit-vendor-btn" data-vendor-code="${v.code}">Edit</button>
                <button class="delete-vendor-btn" data-vendor-code="${v.code}">Delete</button></td>
            </tr>`;
        });
        document.querySelector('#vendorsTable tbody').innerHTML = tableHTML;
    }

    async function addPart() {
        if (!await askForPassword("Enter admin password to add part:")) return;
        const result = await showMessageBox('Add New Part', [ { id: 'partNumber', placeholder: 'Part Number' }, { id: 'description', placeholder: 'Description' }, { id: 'vendorCode', placeholder: 'Vendor Code' }, { id: 'labelType', type: 'select', options: [{value: 'Serial', text: 'Serial'}, {value: 'Batch', text: 'Batch'}] }, { id: 'active', type: 'select', options: [{value: 'Yes', text: 'Yes'}, {value: 'No', text: 'No'}] }, { id: 'internalPartNo', placeholder: 'Internal Part No' } ]);
        if (!result) return;
        
        const newPart = {
            part_number: result.partNumber.trim().toUpperCase(), 
            description: result.description.trim(), 
            vendor_code: result.vendorCode.trim().toUpperCase(), 
            label_type: result.labelType, 
            active: result.active === 'Yes', 
            internal_part_no: result.internalPartNo.trim() 
        };

        showLoading();
        try {
            // FIX: Check if vendor code exists before inserting
            const { data: vendorData, error: vendorError } = await db.from('vendors').select('code').eq('code', newPart.vendor_code).limit(1);
            if (vendorError) throw vendorError;
            if (!vendorData || vendorData.length === 0) {
                throw new Error(`Vendor code "${newPart.vendor_code}" does not exist. Please create the vendor first.`);
            }

            // FIX: Check if part number already exists to prevent conflict
            const { data: partData, error: partError } = await db.from('parts').select('part_number').eq('part_number', newPart.part_number).limit(1);
            if (partError) throw partError;
            if (partData && partData.length > 0) {
                 throw new Error(`Part number "${newPart.part_number}" already exists.`);
            }

            const { error } = await db.from('parts').insert(newPart);
            if(error) throw error;
            await loadParts(); 
        } catch (err) { 
            showError('partsError', 'Error: ' + err.message);
        } finally { hideLoading(); }
    }
    async function editPart(partNumber) {
        if (!await askForPassword("Enter admin password to edit part:")) return;
        const part = allParts.find(p => p.part_number === partNumber);
        if (!part) return;
        
        const result = await showMessageBox('Edit Part', [ { id: 'partNumber', value: part.part_number, placeholder: 'Part Number' }, { id: 'description', value: part.description, placeholder: 'Description' }, { id: 'vendorCode', value: part.vendor_code, placeholder: 'Vendor Code' }, { id: 'labelType', type: 'select', options: [ {value: 'Serial', text: 'Serial', selected: part.label_type === 'Serial'}, {value: 'Batch', text: 'Batch', selected: part.label_type === 'Batch'}] }, { id: 'active', type: 'select', options: [ {value: 'Yes', text: 'Yes', selected: part.active}, {value: 'No', text: 'No', selected: !part.active}] }, { id: 'internalPartNo', value: part.internal_part_no || '', placeholder: 'Internal Part No' } ]);
        if (!result) return;
        
        const updatedPart = {
            part_number: result.partNumber.trim().toUpperCase(), 
            description: result.description.trim(), 
            vendor_code: result.vendorCode.trim().toUpperCase(), 
            label_type: result.labelType, 
            active: result.active === 'Yes', 
            internal_part_no: result.internalPartNo.trim() 
        };

        showLoading();
        try { 
            // FIX: Check if vendor code exists before updating
            const { data: vendorData, error: vendorError } = await db.from('vendors').select('code').eq('code', updatedPart.vendor_code).limit(1);
            if(vendorError) throw vendorError;
            if (!vendorData || vendorData.length === 0) {
                throw new Error(`Vendor code "${updatedPart.vendor_code}" does not exist. Please create the vendor first.`);
            }

            const { error } = await db.from('parts').update(updatedPart).eq('part_number', partNumber);
            if(error) throw error;
            await loadParts(); 
        } catch (err) { 
            showError('partsError', 'Error: ' + err.message);
        } finally { hideLoading(); }
    }
    async function deletePart(partNumber) {
        if (!await askForPassword("Enter admin password to delete part:")) return;
        if (await showMessageBox('Are you sure you want to delete part "' + partNumber + '"?', [], true)) {
            showLoading();
            try { 
                const { error } = await db.from('parts').delete().eq('part_number', partNumber);
                if (error) throw error;
                await loadParts();
            } catch (err) { showError('partsError', 'Error: ' + err.message); } finally { hideLoading();
            }
        }
    }
    async function addVendor() {
        if (!await askForPassword("Enter admin password to add vendor:")) return;
        const result = await showMessageBox('Add New Vendor', [ { id: 'code', placeholder: 'Vendor Code' }, { id: 'name', placeholder: 'Vendor Name' } ]);
        if (!result || !result.code || !result.name) return;
        showLoading();
        try { 
            const { error } = await db.from('vendors').insert({ code: result.code.trim().toUpperCase(), name: result.name.trim() });
            if (error) throw error;
            await loadVendors();
        } catch (err) { showError('vendorsError', 'Error: ' + err.message); } finally { hideLoading();
        }
    }
    async function editVendor(code) {
        if (!await askForPassword("Enter admin password to edit vendor:")) return;
        const vendor = allVendors.find(v => v.code === code);
        const result = await showMessageBox('Edit Vendor', [ { id: 'code', value: vendor.code }, { id: 'name', value: vendor.name } ]);
        if (!result) return;
        showLoading();
        try { 
            const { error } = await db.from('vendors').update({ code: result.code.trim().toUpperCase(), name: result.name.trim() }).eq('code', code);
            if(error) throw error;
            await loadVendors(); 
        } catch (err) { showError('vendorsError', 'Error: ' + err.message);
        } finally { hideLoading(); }
    }
    async function deleteVendor(code) {
        if (!await askForPassword("Enter admin password to delete vendor:")) return;
        if (await showMessageBox('Delete vendor "' + code + '"?', [], true)) {
            showLoading();
            try { 
                const { error } = await db.from('vendors').delete().eq('code', code);
                if (error) throw error;
                await loadVendors(); 
            } catch (err) { showError('vendorsError', 'Error: ' + err.message);
            } finally { hideLoading(); }
        }
    }

    // --- UTILITY FUNCTIONS ---
    function renderPagination(type) {
        const containerId = type === 'Serial' ? 'pagination-history' : 'pagination-batch-history';
        const container = document.getElementById(containerId);
        if (!container) return;
        const { currentPage, itemsPerPage, total } = historyState[type];
        const totalPages = Math.ceil(total / itemsPerPage) || 1;
        const paginationHTML = `
            <button data-type="${type}" data-page="${currentPage - 1}" ${currentPage <= 1 ? 'disabled' : ''}>Previous</button>
            <span>Page ${currentPage} of ${totalPages}</span>
            <button data-type="${type}" data-page="${currentPage + 1}" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>`;
        container.innerHTML = paginationHTML;
        container.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                const type = e.target.dataset.type;
                const page = parseInt(e.target.dataset.page, 10);
                loadHistory(type, page);
            });
        });
    }
    function filterHistory(type) {
        historyState[type].filter = {
            serial: document.getElementById(type === 'Serial' ? 'historySerialSearch' : 'batchHistorySerialSearch').value.trim(),
            part: document.getElementById(type === 'Serial' ? 'historyPartSearch' : 'batchHistoryPartSearch').value.trim(),
            startDate: document.getElementById(type === 'Serial' ? 'historyStartDate' : 'batchHistoryStartDate').value,
            endDate: document.getElementById(type === 'Serial' ? 'historyEndDate' : 'batchHistoryEndDate').value,
        };
        loadHistory(type, 1);
    }
    
    // REPLACE your exportToPDF function with this corrected version
async function exportToPDF(previewAreaId) {
    const previewArea = document.getElementById(previewAreaId);
    if (previewArea.children.length === 0) return showMessageBox('No labels to export.');
    showLoading();
    try {
        const pdf = new jsPDF('l', 'cm', [5, 2.5]);
        // [1] Convert the HTML elements into an array.
        const labelElements = Array.from(previewArea.children);
        // [2] Start all the html2canvas rendering jobs at once.
        // This returns an array of promises, without waiting for them to finish yet.
        const promises = labelElements.map(labelEl =>
            html2canvas(labelEl, { scale: 3, useCORS: true })
        );
        // [3] Wait here for ALL the rendering jobs to complete in parallel.
        const canvases = await Promise.all(promises);
        // [4] Now that all canvases are ready, loop through them and add them to the PDF.
        canvases.forEach((canvas, i) => {
            if (i > 0) pdf.addPage([5, 2.5], 'l');
            pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, 5, 2.5);
        });
        pdf.save('VKM_Labels.pdf');
    } catch (err) {
        showMessageBox('Error exporting to PDF: ' + err.message);
    } finally {
        hideLoading();
    }
}

    function printLabels(previewAreaId) {
        const previewArea = document.getElementById(previewAreaId);
        if (previewArea.children.length === 0) return showMessageBox('No labels to print.');
        const printWindow = window.open('', '_blank', 'width=500,height=500');
        if (!printWindow) return showMessageBox('Pop-up blocker might be preventing printing.');
        const styles = document.getElementById('pure-label-styles').outerHTML;
        printWindow.document.write(`<html><head><title>Print Labels</title>${styles}</head><body>${previewArea.innerHTML}</body></html>`);
        printWindow.document.close();
        printWindow.onload = () => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        };
    }
    function exportToCsv(data, fileName) {
        if (!data || data.length === 0) {
            return showMessageBox('No data to export.');
        }
        showLoading();
        try {
            const headers = Object.keys(data[0]);
            let csvContent = headers.join(',') + '\n';
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] === null || row[header] === undefined ? '' : String(row[header]);
                    return `"${value.replace(/"/g, '""')}"`;
                });
                csvContent += values.join(',') + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch(err) {
            showMessageBox('Error exporting to CSV: ' + err.message);
        } finally {
            hideLoading();
        }
    }
    async function exportHistoryToCsv(type, filtered) {
        showLoading();
        const errorDivId = type === 'Serial' ? 'historyError' : 'batchHistoryError';
        const historyTable = type === 'Serial' ? 'history' : 'batch_history';
        try {
            let query = db.from(historyTable).select('*');
            if (filtered) {
                const filter = historyState[type].filter;
                if (filter.serial) query = query.ilike('serial', `%${filter.serial}%`);
                if (filter.part) query = query.ilike('part', `%${filter.part}%`);
                if (filter.startDate) query = query.gte('created_at', new Date(filter.startDate).toISOString());
                if (filter.endDate) {
                    const endDate = new Date(filter.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    query = query.lte('created_at', endDate.toISOString());
                }
            }
            const { data, error } = await query;
            if(error) throw error;
            if (!data || data.length === 0) return showMessageBox('No data to export.');
            
            exportToCsv(data, `VKM_${type}_History_${(filtered ? 'Filtered' : 'All')}.csv`);
        } catch(err) { showError(errorDivId, 'Error exporting: ' + err.message); } finally { hideLoading(); }
    }
    async function askForPassword(message) {
        const result = await showMessageBox(message, [{ id: 'adminPassword', type: 'password', placeholder: 'Password' }], true);
        if (!result || !result.adminPassword) return false;

        // For real security, this password check MUST be a Supabase Edge Function.
        // This is a placeholder for that secure check.
        // For now, it's a simple client-side check which is NOT secure.
        // TODO: Replace this with a call to a Supabase Edge Function.
        if (result.adminPassword === '123') { // Replace '123' with a temporary password
            return true;
        } else {
            await showMessageBox('Incorrect password.');
            return false;
        }
    }
    function showMessageBox(message, inputs = [], showCancel = false) {
         return new Promise(resolve => {
            const overlay = document.getElementById('messageBoxOverlay');
            document.getElementById('messageBoxText').textContent = message;
            const inputsContainer = document.getElementById('messageBoxInputs');
            inputsContainer.innerHTML = inputs.map(input => {
                if (input.type === 'select') {
                    return `<select id="${input.id}">${input.options.map(opt => 
                        `<option value="${opt.value}" ${opt.selected ? 'selected' : ''}>${opt.text}</option>`
                    ).join('')}</select>`;
                } else {
                    return `<input type="${input.type || 'text'}" id="${input.id}" placeholder="${input.placeholder || ''}" value="${input.value || ''}">`;
                }
            }).join('');

            const confirmBtn = document.getElementById('messageBoxConfirm');
            const cancelBtn = document.getElementById('messageBoxCancel');
            
            cancelBtn.style.display = (showCancel || inputs.length > 0) ? 'inline-block' : 'none';
            
            const close = value => {
                overlay.classList.remove('active');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
                resolve(value);
            };

            confirmBtn.onclick = () => {
                if (inputs.length > 0) {
                    const values = {};
                    inputs.forEach(input => {
                        values[input.id] = document.getElementById(input.id).value;
                    });
                    close(values);
                } else {
                    close(true);
                }
            };
            cancelBtn.onclick = () => close(null);
            overlay.classList.add('active');
        });
    }
    async function toggleReprint() {
        const reprintTab = document.getElementById('reprintTab');
        const reprintBtn = document.getElementById('showReprintBtn');
        if (reprintTab.style.display === 'none') {
            if (await askForPassword("Enter admin password to show reprint tab:")) {
                reprintTab.style.display = 'block';
                reprintBtn.textContent = 'Hide Reprint';
            }
        } else {
            reprintTab.style.display = 'none';
            reprintBtn.textContent = 'Show Reprint';
            if (reprintTab.classList.contains('active')) {
                document.querySelector('.tab[data-tab="serial-generate"]').click();
            }
        }
    }

    // --- INITIALIZATION CALL ---
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', onDomReady);
    } else {
        onDomReady();
    }
  </script>
</body>
</html>
