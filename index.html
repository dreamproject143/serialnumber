<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JHM Serial Number Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Custom styles for the message box */
    #messageBox {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      text-align: center;
      max-width: 90%;
      min-width: 300px;
    }

    #messageBox.alert {
        border: 2px solid #f97316; /* Orange border for alerts */
    }

    #messageBox.error {
        border: 2px solid #ef4444; /* Red border for errors */
    }

    #messageBox.success {
        border: 2px solid #22c55e; /* Green border for success */
    }

    #messageBox button {
      margin-top: 15px;
      padding: 8px 15px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    #messageBox button:hover {
      background-color: #2563eb;
    }

    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none; /* Hidden by default */
    }
    
    /* Loading Spinner Styles */
    #loadingSpinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1001; /* Above message box */
        display: none; /* Hidden by default */
        width: 60px;
        height: 60px;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* General container and font styles */
    body {
      font-family: 'Inter', sans-serif; /* Using Inter font */
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      margin: auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }
    .header h1 {
      font-size: 2.25rem; /* text-4xl */
      font-weight: 700; /* font-bold */
      color: #1a202c; /* gray-900 */
      margin: 0;
    }
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e2e8f0; /* gray-300 */
    }
    .tab-button {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500; /* font-medium */
      color: #4a5568; /* gray-600 */
      border: none;
      background-color: transparent;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .tab-button:hover {
      color: #2b6cb0; /* blue-700 */
    }
    .tab-button.active {
      color: #2b6cb0; /* blue-700 */
      border-bottom-color: #2b6cb0;
      font-weight: 600; /* font-semibold */
    }
    .tab-content {
      padding-top: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600; /* font-semibold */
      color: #2d3748; /* gray-700 */
    }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e0; /* gray-400 */
      border-radius: 6px; /* rounded-md */
      box-sizing: border-box;
      font-size: 1rem;
      color: #2d3748; /* gray-700 */
      transition: border-color 0.2s;
    }
    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group select:focus {
      outline: none;
      border-color: #4299e1; /* blue-500 */
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.1s;
    }
    .btn-primary {
      background-color: #3b82f6; /* blue-600 */
      color: white;
    }
    .btn-primary:hover {
      background-color: #2563eb; /* blue-700 */
      transform: translateY(-1px);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    .btn-secondary {
      background-color: #e2e8f0; /* gray-200 */
      color: #2d3748; /* gray-700 */
      margin-left: 10px;
    }
    .btn-secondary:hover {
      background-color: #cbd5e0; /* gray-300 */
      transform: translateY(-1px);
    }
    .btn-secondary:active {
      transform: translateY(0);
    }
    .text-danger {
      color: #e53e3e; /* red-600 */
      font-size: 0.875rem; /* text-sm */
      margin-top: 5px;
    }
    .text-success {
      color: #38a169; /* green-600 */
      font-size: 0.875rem; /* text-sm */
      margin-top: 5px;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .data-table th, .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
    }
    .data-table th {
      background-color: #f7fafc; /* gray-50 */
      font-weight: 600;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .data-table tbody tr:hover {
      background-color: #edf2f7; /* gray-100 */
    }
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }

    .pagination-controls button {
        padding: 8px 12px;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .pagination-controls button:hover:not(:disabled) {
        background-color: #edf2f7;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-controls span {
        font-weight: 500;
        color: #4a5568;
    }

    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center items-start p-5">
  <div class="container bg-white rounded-lg shadow-lg p-8 md:p-10">
    <div class="header">
      <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">JHM Serial Number Generator</h1>
      <img id="logo" src="" alt="JHM Logo" class="h-16 w-16 md:h-20 md:w-20 rounded-md">
    </div>

    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab('generator')">Generator</button>
      <button class="tab-button" onclick="openTab('parts')">Parts Management</button>
      <button class="tab-button" onclick="openTab('vendors')">Vendors Management</button>
      <button class="tab-button" onclick="openTab('history')">History</button>
    </div>

    <div id="generator" class="tab-content">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Generate Serial Number</h2>
      <div class="form-group">
        <label for="partSelect" class="block text-gray-700 font-semibold mb-2">Select Part:</label>
        <select id="partSelect" class="form-select"></select>
        <p id="partDescription" class="text-sm text-gray-600 mt-2"></p>
        <p id="partVendorCode" class="text-sm text-gray-600"></p>
        <p id="generateError" class="text-danger"></p>
      </div>
      <div class="form-group">
        <label for="currentDailyCounterDisplay" class="block text-gray-700 font-semibold mb-2">Current Daily Counter:</label>
        <span id="currentDailyCounterDisplay" class="text-xl font-bold text-blue-600">Loading...</span>
      </div>
      <div class="form-group">
        <label for="quantity" class="block text-gray-700 font-semibold mb-2">Quantity:</label>
        <input type="number" id="quantity" value="1" min="1" class="form-input" />
      </div>
      <div class="flex flex-wrap gap-4 mt-6">
        <button class="btn btn-primary" onclick="generateSerialNumbers()">Generate Serial Number(s)</button>
        <button class="btn btn-secondary" onclick="exportSerialNumbers()">Export as PDF</button>
      </div>
      <div id="serialNumberOutput" class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Generated Serial Numbers:</h3>
        <pre id="generatedSerials" class="text-gray-700 whitespace-pre-wrap"></pre>
        <button id="copySerialsBtn" class="btn btn-secondary mt-4" style="display: none;">Copy to Clipboard</button>
      </div>
    </div>

    <div id="parts" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Parts Management</h2>
      <div class="mb-4 flex flex-wrap gap-4">
        <input type="text" id="partNumber" placeholder="Part Number" class="p-2 border rounded-md flex-grow">
        <input type="text" id="partDescriptionInput" placeholder="Description" class="p-2 border rounded-md flex-grow">
        <select id="partVendorCodeInput" class="p-2 border rounded-md">
          <option value="">Select Vendor</option>
        </select>
        <select id="partActiveInput" class="p-2 border rounded-md">
          <option value="Yes">Active</option>
          <option value="No">Inactive</option>
        </select>
        <button class="btn btn-primary" onclick="addPart()">Add Part</button>
      </div>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Part Number</th>
              <th>Description</th>
              <th>Vendor Code</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="partsTableBody">
            <!-- Parts will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="vendors" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Vendors Management</h2>
      <div class="mb-4 flex flex-wrap gap-4">
        <input type="text" id="vendorCode" placeholder="Vendor Code" class="p-2 border rounded-md w-1/4">
        <input type="text" id="vendorName" placeholder="Vendor Name" class="p-2 border rounded-md flex-grow">
        <button class="btn btn-primary" onclick="addVendor()">Add Vendor</button>
      </div>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="vendorsTableBody">
            <!-- Vendors will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="history" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">History</h2>
      <div class="mb-4 flex flex-wrap gap-4">
        <input type="text" id="historySerialSearch" placeholder="Search by Serial" class="p-2 border rounded-md flex-grow">
        <input type="text" id="historyPartSearch" placeholder="Search by Part" class="p-2 border rounded-md flex-grow">
        <button class="btn btn-primary" onclick="loadHistory(true)">Apply Filter</button>
        <button class="btn btn-secondary" onclick="exportFilteredHistory()">Export Filtered History</button>
        <button class="btn btn-secondary" onclick="exportAllHistory()">Export All History</button>
      </div>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Serial</th>
              <th>Part</th>
              <th>Description</th>
              <th>Vendor Code</th>
              <th>Date</th>
              <th>Counter</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- History will be loaded here -->
          </tbody>
        </table>
      </div>
      <div class="pagination-controls">
        <button onclick="changePage(-1)" id="prevPageBtn">Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button onclick="changePage(1)" id="nextPageBtn">Next</button>
      </div>
    </div>

  </div>

  <!-- Message Box HTML -->
  <div id="overlay" class="hidden"></div>
  <div id="messageBox" class="hidden">
    <p id="messageText"></p>
    <button onclick="hideMessageBox()">OK</button>
  </div>

  <!-- Loading Spinner HTML -->
  <div id="loadingSpinner" class="hidden"></div>

  <script>
    // NEW GAS_WEB_APP_URL for GET-only API
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwYlAOxC0yz3UFukVmSRAnlQY1KJ06QVgZmqnT9JLYx8rXtkX1nseEhmMaRA-UXLXWOZg/exec";
    let TESLA_LOGO_BASE64 = 'https://placehold.co/100x100?text=Logo'; // Default placeholder

    let currentParts = [];
    let currentVendors = [];
    let currentPage = 1;
    const itemsPerPage = 20; // Number of items per page for history

    // Function to show the loading spinner
    function showLoading() {
        document.getElementById('loadingSpinner').classList.remove('hidden');
        document.getElementById('overlay').classList.remove('hidden');
    }

    // Function to hide the loading spinner
    function hideLoading() {
        document.getElementById('loadingSpinner').classList.add('hidden');
        document.getElementById('overlay').classList.add('hidden');
    }

    // Function to show a custom message box
    function showMessageBox(message, type = 'info') {
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const overlay = document.getElementById('overlay');

        messageText.textContent = message;
        messageBox.className = ''; // Clear existing classes
        messageBox.classList.add('block'); // Show the message box
        overlay.classList.add('block'); // Show overlay

        // Add type-specific classes for styling
        if (type === 'alert') {
            messageBox.classList.add('alert');
        } else if (type === 'error') {
            messageBox.classList.add('error');
        } else if (type === 'success') {
            messageBox.classList.add('success');
        }
    }

    // Function to hide the custom message box
    function hideMessageBox() {
        document.getElementById('messageBox').classList.remove('block');
        document.getElementById('overlay').classList.remove('block');
    }

    /**
     * Generic function to call Google Apps Script Web App using GET requests.
     * @param {string} action The name of the Apps Script function to call.
     * @param {Object} [payload={}] The data payload for the Apps Script function.
     * @returns {Promise<any>} A promise that resolves with the response data or rejects with an error.
     */
    async function callGAS(action, payload = {}) {
      const url = new URL(GAS_WEB_APP_URL);
      url.searchParams.append('action', action);
      // Stringify the payload and encode it for URL parameter
      url.searchParams.append('payload', JSON.stringify(payload));

      try {
        const response = await fetch(url.toString(), {
          method: 'GET', // Explicitly use GET
          // No headers or body for simple GET requests
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }
        return data;
      } catch (error) {
        console.error(`Error calling GAS function '${action}':`, error);
        showMessageBox(`Error: ${error.message}`, 'error');
        throw error;
      }
    }

    // Function to check login status (if any authentication were implemented)
    function checkLoginStatus() {
      // In this version, there's no explicit login. We proceed directly to initialize.
      initialize();
    }

    // Function to switch tabs
    function openTab(tabName) {
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.add('hidden'));

      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(button => button.classList.remove('active'));

      document.getElementById(tabName).classList.remove('hidden');
      document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');

      // Specific load functions for tabs that need data on display
      if (tabName === 'parts') {
        loadParts();
      } else if (tabName === 'vendors') {
        loadVendors();
        populatePartVendorSelect(); // Refresh vendors for part management
      } else if (tabName === 'history') {
        currentPage = 1; // Reset to first page when history tab is opened
        loadHistory(true); // Load history with filters applied (initially no filters)
      }
    }

    // Generate random serial numbers
    async function generateSerialNumbers() {
      const partSelect = document.getElementById('partSelect');
      const selectedPartNumber = partSelect.value;
      const quantity = parseInt(document.getElementById('quantity').value, 10);
      const generatedSerialsElement = document.getElementById('generatedSerials');
      const copySerialsBtn = document.getElementById('copySerialsBtn');
      const generateErrorElement = document.getElementById('generateError');

      generateErrorElement.textContent = ''; // Clear previous errors

      if (!selectedPartNumber) {
        generateErrorElement.textContent = 'Please select a part.';
        return;
      }
      if (isNaN(quantity) || quantity < 1) {
        generateErrorElement.textContent = 'Quantity must be at least 1.';
        return;
      }

      showLoading();
      try {
        const counterResponse = await callGAS('getCounter');
        let currentCounter = counterResponse.counter;

        // Use standard JavaScript Date methods for formatting
        const now = new Date();
        const year = String(now.getFullYear()).slice(-2); // Last two digits of year
        const month = String(now.getMonth() + 1).padStart(2, '0'); // Month (0-11) + 1, pad with 0
        const day = String(now.getDate()).padStart(2, '0'); // Day of month, pad with 0
        const date = `${year}${month}${day}`; // Format as yyMMdd

        const serials = [];
        const historyEntries = [];

        for (let i = 0; i < quantity; i++) {
          const formattedCounter = String(currentCounter).padStart(5, '0');
          const serial = `${selectedPartNumber}${date}${formattedCounter}`;
          serials.push(serial);

          const selectedPart = currentParts.find(p => p['Part Number'] === selectedPartNumber);
          historyEntries.push({
            Serial: serial,
            Part: selectedPart['Part Number'],
            Description: selectedPart.Description,
            'Vendor Code': selectedPart['Vendor Code'],
            Date: new Date().toLocaleDateString('en-US'), // Keep local date string for history
            Counter: currentCounter
          });
          currentCounter++; // Increment for next serial
        }

        // Update the counter in Apps Script by the generated quantity
        await callGAS('incrementCounter', { quantity: quantity });
        await callGAS('setHistory', { entries: historyEntries });

        generatedSerialsElement.textContent = serials.join('\n');
        copySerialsBtn.style.display = 'block';
        document.getElementById('currentDailyCounterDisplay').textContent = (currentCounter); // Update displayed counter

        showMessageBox(`Successfully generated ${quantity} serial number(s)!`, 'success');

      } catch (error) {
        console.error('Error generating serial numbers:', error);
        generateErrorElement.textContent = 'Failed to generate serial numbers: ' + error.message;
      } finally {
        hideLoading();
      }
    }

    // Export generated serial numbers as PDF
    function exportSerialNumbers() {
      const generatedSerials = document.getElementById('generatedSerials').textContent;
      if (!generatedSerials) {
        showMessageBox('No serial numbers to export.', 'alert');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(12);
      const lines = doc.splitTextToSize(generatedSerials, 180);
      doc.text(lines, 10, 10);
      doc.save('generated_serial_numbers.pdf');
      showMessageBox('Serial numbers exported to PDF successfully!', 'success');
    }

    // Copy generated serial numbers to clipboard
    document.getElementById('copySerialsBtn').addEventListener('click', () => {
      const generatedSerials = document.getElementById('generatedSerials').textContent;
      if (generatedSerials) {
        // Use document.execCommand('copy') as navigator.clipboard.writeText() may not work in iframes
        const textarea = document.createElement('textarea');
        textarea.value = generatedSerials;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showMessageBox('Serial numbers copied to clipboard!', 'success');
        } catch (err) {
          console.error('Failed to copy text: ', err);
          showMessageBox('Failed to copy serial numbers.', 'error');
        }
        document.body.removeChild(textarea);
      } else {
        showMessageBox('No serial numbers to copy.', 'alert');
      }
    });

    // Load parts into the dropdown and table
    async function loadParts() {
      showLoading();
      try {
        const response = await callGAS('getParts');
        currentParts = response;
        populatePartSelect();
        populatePartsTable();
      } catch (error) {
        console.error('Error loading parts:', error);
        showMessageBox('Failed to load parts. Please check your spreadsheet.', 'error');
      } finally {
        hideLoading();
      }
    }

    // Populate the select dropdown for parts
    function populatePartSelect() {
      const partSelect = document.getElementById('partSelect');
      partSelect.innerHTML = '<option value="">Select a Part Number</option>'; // Clear existing options
      currentParts.forEach(part => {
        if (part.Active === 'Yes') { // Only show active parts
          const option = document.createElement('option');
          option.value = part['Part Number'];
          option.textContent = `${part['Part Number']} - ${part.Description}`;
          partSelect.appendChild(option);
        }
      });
      // Update description and vendor code when a part is selected
      partSelect.onchange = () => {
        const selectedPart = currentParts.find(p => p['Part Number'] === partSelect.value);
        document.getElementById('partDescription').textContent = selectedPart ? `Description: ${selectedPart.Description}` : '';
        document.getElementById('partVendorCode').textContent = selectedPart ? `Vendor Code: ${selectedPart['Vendor Code']}` : '';
      };
      // Trigger change to set initial description/vendor if a part is pre-selected (e.g., after reload)
      if (partSelect.value) partSelect.onchange();
    }

    // Populate parts table
    function populatePartsTable() {
      const partsTableBody = document.getElementById('partsTableBody');
      partsTableBody.innerHTML = '';
      currentParts.forEach(part => {
        const row = partsTableBody.insertRow();
        row.insertCell().textContent = part['Part Number'];
        row.insertCell().textContent = part.Description;
        row.insertCell().textContent = part['Vendor Code'];
        row.insertCell().textContent = part.Active;
        const actionsCell = row.insertCell();
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'btn btn-secondary mr-2';
        editBtn.onclick = () => editPart(part);
        actionsCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn btn-danger';
        deleteBtn.onclick = () => deletePart(part['Part Number']);
        actionsCell.appendChild(deleteBtn);
      });
    }

    // Add new part
    async function addPart() {
      const partNumber = document.getElementById('partNumber').value.trim();
      const description = document.getElementById('partDescriptionInput').value.trim();
      const vendorCode = document.getElementById('partVendorCodeInput').value.trim();
      const active = document.getElementById('partActiveInput').value;

      if (!partNumber || !description || !vendorCode) {
        showMessageBox('Please fill all Part fields.', 'alert');
        return;
      }

      const existingPart = currentParts.find(p => p['Part Number'] === partNumber);
      if (existingPart) {
        showMessageBox('Part Number already exists. Please use "Edit" to modify.', 'alert');
        return;
      }

      const newPart = {
        'Part Number': partNumber,
        Description: description,
        'Vendor Code': vendorCode,
        Active: active
      };

      currentParts.push(newPart); // Add to local array immediately
      await updatePartsInGAS(); // Send updated array to GAS
      document.getElementById('partNumber').value = '';
      document.getElementById('partDescriptionInput').value = '';
      document.getElementById('partVendorCodeInput').value = '';
      document.getElementById('partActiveInput').value = 'Yes'; // Reset to default
      showMessageBox('Part added successfully!', 'success');
    }

    // Edit part (opens a modal or populates form)
    function editPart(part) {
        const newPartNumber = prompt("Edit Part Number:", part['Part Number']);
        if (newPartNumber !== null) { // Check if user clicked OK
            const newDescription = prompt("Edit Description:", part.Description);
            if (newDescription !== null) {
                const newVendorCode = prompt("Edit Vendor Code:", part['Vendor Code']);
                if (newVendorCode !== null) {
                    const newActive = prompt("Edit Active (Yes/No):", part.Active);
                    if (newActive !== null) {
                        const updatedActive = (newActive.toLowerCase() === 'yes' || newActive.toLowerCase() === 'y') ? 'Yes' : 'No';

                        const index = currentParts.findIndex(p => p['Part Number'] === part['Part Number']);
                        if (index !== -1) {
                            currentParts[index] = {
                                'Part Number': newPartNumber.trim(),
                                Description: newDescription.trim(),
                                'Vendor Code': newVendorCode.trim(),
                                Active: updatedActive
                            };
                            updatePartsInGAS();
                            showMessageBox('Part updated successfully!', 'success');
                        }
                    }
                }
            }
        }
    }


    // Delete part
    async function deletePart(partNumber) {
      if (confirm(`Are you sure you want to delete part ${partNumber}?`)) {
        currentParts = currentParts.filter(p => p['Part Number'] !== partNumber);
        await updatePartsInGAS();
        showMessageBox('Part deleted successfully!', 'success');
      }
    }

    // Send updated parts array to GAS
    async function updatePartsInGAS() {
      showLoading();
      try {
        await callGAS('setParts', currentParts); // Send the entire updated array
        await loadParts(); // Reload to refresh UI and ensure consistency
      } catch (error) {
        console.error('Error updating parts in GAS:', error);
        showMessageBox('Failed to save parts changes.', 'error');
      } finally {
        hideLoading();
      }
    }

    // Load vendors into the table and part creation dropdown
    async function loadVendors() {
      showLoading();
      try {
        const response = await callGAS('getVendors');
        currentVendors = response;
        populateVendorsTable();
        populatePartVendorSelect(); // Always update part vendor select when vendors are loaded
      } catch (error) {
        console.error('Error loading vendors:', error);
        showMessageBox('Failed to load vendors. Please check your spreadsheet.', 'error');
      } finally {
        hideLoading();
      }
    }

    // Populate vendors table
    function populateVendorsTable() {
      const vendorsTableBody = document.getElementById('vendorsTableBody');
      vendorsTableBody.innerHTML = '';
      currentVendors.forEach(vendor => {
        const row = vendorsTableBody.insertRow();
        row.insertCell().textContent = vendor.Code;
        row.insertCell().textContent = vendor.Name;
        const actionsCell = row.insertCell();
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'btn btn-secondary mr-2';
        editBtn.onclick = () => editVendor(vendor);
        actionsCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn btn-danger';
        deleteBtn.onclick = () => deleteVendor(vendor.Code);
        actionsCell.appendChild(deleteBtn);
      });
    }

    // Populate the vendor select dropdown for parts management
    function populatePartVendorSelect() {
      const partVendorCodeSelect = document.getElementById('partVendorCodeInput');
      partVendorCodeSelect.innerHTML = '<option value="">Select Vendor</option>'; // Clear existing options
      currentVendors.forEach(vendor => {
        const option = document.createElement('option');
        option.value = vendor.Code;
        option.textContent = `${vendor.Code} - ${vendor.Name}`;
        partVendorCodeSelect.appendChild(option);
      });
    }

    // Add new vendor
    async function addVendor() {
      const vendorCode = document.getElementById('vendorCode').value.trim();
      const vendorName = document.getElementById('vendorName').value.trim();

      if (!vendorCode || !vendorName) {
        showMessageBox('Please fill all Vendor fields.', 'alert');
        return;
      }

      const existingVendor = currentVendors.find(v => v.Code === vendorCode);
      if (existingVendor) {
        showMessageBox('Vendor Code already exists. Please use "Edit" to modify.', 'alert');
        return;
      }

      const newVendor = {
        Code: vendorCode,
        Name: vendorName
      };

      currentVendors.push(newVendor); // Add to local array immediately
      await updateVendorsInGAS(); // Send updated array to GAS
      document.getElementById('vendorCode').value = '';
      document.getElementById('vendorName').value = '';
      showMessageBox('Vendor added successfully!', 'success');
    }

    // Edit vendor
    function editVendor(vendor) {
      const newVendorCode = prompt("Edit Vendor Code:", vendor.Code);
      if (newVendorCode !== null) {
          const newVendorName = prompt("Edit Vendor Name:", vendor.Name);
          if (newVendorName !== null) {
              const index = currentVendors.findIndex(v => v.Code === vendor.Code);
              if (index !== -1) {
                  currentVendors[index] = {
                      Code: newVendorCode.trim(),
                      Name: newVendorName.trim()
                  };
                  updateVendorsInGAS();
                  showMessageBox('Vendor updated successfully!', 'success');
              }
          }
      }
    }

    // Delete vendor
    async function deleteVendor(vendorCode) {
      if (confirm(`Are you sure you want to delete vendor ${vendorCode}?`)) {
        currentVendors = currentVendors.filter(v => v.Code !== vendorCode);
        await updateVendorsInGAS();
        showMessageBox('Vendor deleted successfully!', 'success');
      }
    }

    // Send updated vendors array to GAS
    async function updateVendorsInGAS() {
      showLoading();
      try {
        await callGAS('setVendors', currentVendors); // Send the entire updated array
        await loadVendors(); // Reload to refresh UI and ensure consistency
      } catch (error) {
        console.error('Error updating vendors in GAS:', error);
        showMessageBox('Failed to save vendor changes.', 'error');
      } finally {
        hideLoading();
      }
    }

    // Load history data with pagination and filters
    async function loadHistory(applyFilter = false) {
      showLoading();
      try {
        const serialSearch = document.getElementById('historySerialSearch').value.trim();
        const partSearch = document.getElementById('historyPartSearch').value.trim();

        const payload = {
          offset: (currentPage - 1) * itemsPerPage,
          limit: itemsPerPage,
          serial: serialSearch,
          part: partSearch
        };

        const response = await callGAS('getPaginatedHistory', payload);
        const historyData = response.data;
        const totalItems = response.total;

        const historyTableBody = document.getElementById('historyTableBody');
        historyTableBody.innerHTML = '';

        if (historyData.length === 0 && applyFilter) {
          showMessageBox('No matching history records found for the applied filter.', 'alert');
        } else if (historyData.length === 0) {
          showMessageBox('No history records found.', 'alert');
        }

        historyData.forEach(entry => {
          const row = historyTableBody.insertRow();
          row.insertCell().textContent = entry.Serial;
          row.insertCell().textContent = entry.Part;
          row.insertCell().textContent = entry.Description;
          row.insertCell().textContent = entry['Vendor Code'];
          row.insertCell().textContent = entry.Date;
          row.insertCell().textContent = entry.Counter;
        });

        updatePaginationControls(totalItems);

      } catch (error) {
        console.error('Error loading history:', error);
        showMessageBox('Failed to load history.', 'error');
      } finally {
        hideLoading();
      }
    }

    // Pagination controls logic
    function updatePaginationControls(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
    }

    function changePage(direction) {
      const totalItems = parseInt(document.getElementById('pageInfo').textContent.split(' ')[3]); // Extract total from "Page X of Y"
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const newPage = currentPage + direction;

      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        loadHistory();
      }
    }

    // Export filtered history to CSV
    async function exportFilteredHistory() {
      showLoading();
      try {
        const serialSearch = document.getElementById('historySerialSearch').value.trim();
        const partSearch = document.getElementById('historyPartSearch').value.trim();

        const payload = {
          serial: serialSearch,
          part: partSearch
        };
        const response = await callGAS('getFilteredHistory', payload); // Get all filtered data
        
        if (response.length === 0) {
          showMessageBox('No records to export with the current filter.', 'alert');
          return;
        }

        const headers = Object.keys(response[0]);
        let csv = headers.join(',') + '\n';
        response.forEach(row => {
          csv += headers.map(header => `"${String(row[header]).replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'filtered_history.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessageBox('Filtered history exported to Excel (CSV) successfully!', 'success');
      } catch (error) {
        console.error('Error exporting filtered history:', error);
        showMessageBox('Failed to export filtered history.', 'error');
      } finally {
        hideLoading();
      }
    }

    // Export all history to CSV
    async function exportAllHistory() {
      showLoading();
      try {
        const response = await callGAS('getHistory'); // Get all history data
        
        if (response.length === 0) {
          showMessageBox('No history records to export.', 'alert');
          return;
        }

        const headers = Object.keys(response[0]);
        let csv = headers.join(',') + '\n';
        response.forEach(row => {
          csv += headers.map(header => `"${String(row[header]).replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'all_history.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessageBox('All history exported to Excel (CSV) successfully!', 'success');
      } catch (error) {
        console.error('Error exporting all history:', error);
        showMessageBox('Failed to export all history.', 'error');
      } finally {
        hideLoading();
      }
    }


    // Fetch and set the logo from Google Drive
    async function getTeslaLogoBase64() {
      showLoading();
      try {
        // Replace with your actual Drive file ID for the logo
        const fileId = "1en7umlfHN1huVyIsNNib8FzzJdPaiDvP"; 
        const data = await callGAS("getLogoBase64FromDrive", { fileId: fileId });
        if (data && data !== 'ERROR_LOADING_LOGO') {
          TESLA_LOGO_BASE64 = data;
          document.getElementById('logo').src = TESLA_LOGO_BASE64;
        } else {
          console.warn("Failed to load logo from Drive, using placeholder.");
          document.getElementById('logo').src = 'https://placehold.co/100x100?text=Logo';
        }
      } catch (err) {
        console.error("Failed to load logo:", err);
        document.getElementById('logo').src = 'https://placehold.co/100x100?text=Logo'; // Fallback to placeholder
      } finally {
        hideLoading();
      }
    }

    // Load initial data on page load
    async function initialize() {
      showLoading();
      try {
        console.log("initialize called");
        await getTeslaLogoBase64(); 
        await Promise.all([
          loadParts(), 
          loadVendors(), 
          // loadHistory() is now called when the history tab is clicked or explicitly for "Export All"
          callGAS('getCounter').then(function(response) {
              if (response && response.counter !== undefined) {
                  document.getElementById('currentDailyCounterDisplay').textContent = response.counter;
              } else {
                  document.getElementById('currentDailyCounterDisplay').textContent = 'N/A';
              }
          }).catch(function(error) {
              console.error("Error loading counter:", error);
              document.getElementById('currentDailyCounterDisplay').textContent = 'Error';
          })
        ]);
      }
      catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('generateError').textContent = 'Initialization failed: ' + error.message;
      } finally {
        hideLoading();
      }
    }

    checkLoginStatus(); // Initial call
  </script>
</body>
</html>
